<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="referrer" content="no-referrer">

    <!-- PWA 配置 -->
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <title>CyberSonic - 智能云音乐</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 引入复古字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00f2ea;
            --secondary: #ff0050;
            --bg-dark: #0a0a0a;
            --panel-bg: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-sub: rgba(255, 255, 255, 0.6);
            --blur-val: 40px;
            --nav-height: 60px;
            --retro-green: #33ff00;
            --retro-amber: #ffb000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        body {
            font-family: 'PingFang SC', 'Helvetica Neue', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 全局动态背景 */
        .app-bg {
            position: fixed;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background-image: url('https://images.unsplash.com/photo-1614149162883-504ce4d13909?q=80&w=2574&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            filter: blur(var(--blur-val)) brightness(0.4);
            z-index: -1;
            transition: background-image 1s ease;
        }

        /* 主容器 */
        .app-container {
            width: 1200px;
            height: 85vh;
            max-height: 900px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: 260px 1fr 340px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            transition: opacity 0.3s ease;
        }

        /* 复古模式下隐藏原来的主界面 */
        body.retro-mode .app-container {
            opacity: 0;
            pointer-events: none;
        }

        /* 复古模式背景 */
        body.retro-mode .bg-animation {
            opacity: 0;
        }

        body.retro-mode .bg-overlay {
            background: #2b2b2b;
            background-image: radial-gradient(#3a3a3a 15%, transparent 16%), radial-gradient(#3a3a3a 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        /* 1. 左侧导航栏 */
        .sidebar {
            padding: 30px 20px;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            gap: 30px;
            height: 100%;
            overflow-y: auto;
        }

        .brand {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            text-shadow: 0 0 15px rgba(0, 242, 234, 0.5);
            flex-shrink: 0;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-sub);
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .nav-item.active {
            background: rgba(0, 242, 234, 0.1);
            color: var(--primary);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* 2. 中间主内容区 */
        .main-view {
            padding: 30px;
            overflow-y: auto;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .search-bar {
            display: flex;
            background: var(--panel-bg);
            padding: 8px 15px;
            border-radius: 100px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
            flex-shrink: 0;
            height: 50px;
        }

        .source-select {
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            outline: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            margin-right: 10px;
            appearance: none;
            -webkit-appearance: none;
            text-align: center;
            transition: 0.3s;
        }

        .source-select:hover {
            background: rgba(0, 242, 234, 0.1);
        }

        .source-select option {
            background: #1a1a1a;
            color: #fff;
            padding: 10px;
        }

        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 16px;
            margin-left: 5px;
            width: 100%;
        }

        .search-btn {
            cursor: pointer;
            color: var(--text-sub);
            transition: 0.3s;
            padding: 5px;
        }

        .search-btn:hover {
            color: var(--primary);
        }

        .song-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 20px;
        }

        .song-item {
            display: grid;
            grid-template-columns: 40px 1.5fr 1fr 50px;
            align-items: center;
            padding: 10px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .song-item.active {
            background: rgba(0, 242, 234, 0.15);
            border-left: 3px solid var(--primary);
        }

        .song-index {
            color: var(--text-sub);
            font-size: 14px;
            text-align: center;
        }

        .song-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }

        .song-artist {
            color: var(--text-sub);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-source {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            text-align: center;
            width: fit-content;
        }

        /* 3. 右侧播放详情 */
        .player-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            height: 100%;
            overflow: hidden;
        }

        .player-panel.card-mode {
            background: rgba(0, 0, 0, 0.8);
        }

        .album-art {
            width: 220px;
            height: 220px;
            max-height: 30vh;
            aspect-ratio: 1/1;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 20s linear;
        }

        .album-art.playing img {
            animation: rotate 20s linear infinite;
            border-radius: 50%;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* 歌曲信息显示区域 */
        .song-info-area {
            text-align: center;
            width: 100%;
            margin-bottom: 10px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
            padding: 0 15px;
        }

        .current-title {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .current-artist {
            font-size: 14px;
            color: var(--text-sub);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        /* 歌词区域 */
        .lyrics-wrapper {
            flex: 1;
            width: 100%;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            mask-image: linear-gradient(transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(transparent 0%, black 15%, black 85%, transparent 100%);
            text-align: center;
            position: relative;
            scroll-behavior: smooth;
            margin-bottom: 10px;
        }

        .lyrics-wrapper::-webkit-scrollbar {
            display: none;
        }

        .lyrics-inner {
            padding: 50% 0;
        }

        .lyric-line {
            padding: 10px 0;
            color: var(--text-sub);
            font-size: 15px;
            transition: 0.3s;
            cursor: pointer;
            min-height: 30px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lyric-line .trans {
            font-size: 12px;
            opacity: 0.6;
            font-weight: normal;
        }

        .lyric-line:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .lyric-line.active {
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transform: scale(1.02);
        }

        .lyric-line.active .trans {
            color: var(--primary);
            opacity: 0.9;
        }

        .lyric-line.selected {
            color: #fff;
            background: rgba(255, 0, 80, 0.2);
            border: 1px solid rgba(255, 0, 80, 0.4);
        }

        .player-panel.card-mode .lyric-line:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* 播放控制器 */
        .controls {
            width: 100%;
            margin-top: auto;
            flex-shrink: 0;
            padding-top: 10px;
            position: relative;
            z-index: 5;
        }

        #visualizerCanvas {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            z-index: -1;
            opacity: 0.3;
            pointer-events: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-bottom: 15px;
            cursor: pointer;
            position: relative;
            z-index: 2;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            border-radius: 2px;
            position: relative;
        }

        .btn-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            position: relative;
            z-index: 2;
        }

        .ctrl-btn {
            background: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 18px;
            transition: 0.2s;
            opacity: 0.7;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ctrl-btn:hover {
            color: var(--primary);
            transform: scale(1.1);
            opacity: 1;
        }

        .ctrl-btn.active {
            color: var(--secondary);
            opacity: 1;
            text-shadow: 0 0 10px var(--secondary);
        }

        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            flex-shrink: 0;
            background: #fff;
            color: #000;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            border: none;
            cursor: pointer;
        }

        .play-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
            color: #000;
        }

        /* 音量控制条 */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            justify-content: center;
            margin-top: 15px;
        }

        .volume-slider {
            -webkit-appearance: none;
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--primary);
        }

        /* 歌词卡片入口 */
        .card-entry-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.3s;
            z-index: 10;
        }

        .card-entry-btn:hover {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
        }

        .card-entry-btn.active {
            background: var(--secondary);
            color: #fff;
            border-color: var(--secondary);
        }

        .card-actions-bar {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            gap: 10px;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            white-space: nowrap;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 20;
        }

        .player-panel.card-mode .card-actions-bar {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .action-pill {
            background: var(--secondary);
            color: #fff;
            border: none;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
        }

        .action-pill:hover {
            transform: scale(1.05);
        }

        .action-pill.cancel {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* 探索雷达 */
        #radarView {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .radar-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(0, 242, 234, 0.3);
            margin-bottom: 40px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .radar-circle:hover {
            transform: scale(1.05);
        }

        .radar-scan {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 242, 234, 0.5) 60deg, transparent 60deg);
            animation: scan 2s linear infinite;
            display: none;
        }

        .radar-circle.scanning .radar-scan {
            display: block;
        }

        .radar-text {
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        @keyframes scan {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* 时光收音机 (Retro FM) 样式 */
        .retro-layer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        body.retro-mode .retro-layer {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .radio-container {
            width: 800px;
            max-width: 100%;
            background: #d4c5a9;
            border-radius: 20px;
            padding: 30px;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.2), 0 20px 50px rgba(0, 0, 0, 0.6);
            border: 8px solid #5d4037;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            transform: scale(0.9);
        }

        .retro-exit-btn {
            position: absolute;
            top: -50px;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .retro-exit-btn:hover {
            background: var(--secondary);
            border-color: var(--secondary);
        }

        .speaker-grill {
            position: absolute;
            left: 20px;
            top: 20px;
            bottom: 20px;
            width: 150px;
            background-image: radial-gradient(#5d4037 20%, transparent 20%);
            background-size: 8px 8px;
            border-radius: 10px;
            opacity: 0.6;
            border: 2px solid #bcaaa4;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        .speaker-grill.right {
            left: auto;
            right: 20px;
        }

        .radio-display-area {
            margin: 0 160px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .radio-screen {
            background: #2c3e50;
            height: 120px;
            border-radius: 10px;
            border: 4px solid #bdc3c7;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .cassette-container {
            width: 240px;
            height: 150px;
            background: #333;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .cassette {
            width: 100%;
            height: 100%;
            background: #eee;
            border-radius: 5px;
            position: relative;
            display: flex;
            justify-content: space-between;
            padding: 15px 35px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            background: linear-gradient(to bottom, #ddd 0%, #fff 20%, #eee 100%);
        }

        .tape-label {
            position: absolute;
            top: 10px;
            left: 10%;
            width: 80%;
            height: 60px;
            background: #e67e22;
            z-index: 1;
            border-radius: 4px;
            text-align: center;
            line-height: 20px;
            padding-top: 5px;
            font-family: monospace;
            font-weight: bold;
            font-size: 12px;
            color: #333;
        }

        .tape-window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -30%);
            width: 120px;
            height: 40px;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            padding: 5px 15px;
        }

        .tape-wheel {
            width: 30px;
            height: 30px;
            border: 8px solid #fff;
            border-radius: 50%;
            border-left-color: transparent;
            border-right-color: transparent;
        }

        .playing .tape-wheel {
            animation: rotate 2s linear infinite;
        }

        .radio-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            background: #4e342e;
            padding: 15px;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .channel-btn {
            background: #8d6e63;
            border: none;
            color: #fff;
            width: 60px;
            height: 40px;
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            box-shadow: 0 4px 0 #5d4037;
            cursor: pointer;
            transition: all 0.1s;
        }

        .channel-btn:active,
        .channel-btn.active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #5d4037;
            background: #d35400;
        }

        .lcd-display {
            background: #8fbc8f;
            padding: 10px 20px;
            border-radius: 4px;
            font-family: monospace;
            color: #2f4f4f;
            text-align: center;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.2);
            border: 2px solid #556b2f;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .lcd-text-main {
            font-size: 18px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lcd-text-sub {
            font-size: 12px;
            margin-top: 5px;
        }

        .control-knob {
            width: 60px;
            height: 60px;
            background: #333;
            border-radius: 50%;
            border: 4px solid #666;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .control-knob::after {
            content: '';
            width: 6px;
            height: 20px;
            background: #fff;
            position: absolute;
            top: 5px;
            border-radius: 3px;
        }

        /* 复古歌词显示屏 */
        .retro-lyrics-panel {
            background: #111;
            border: 4px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin: 0 100px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.9);
            overflow: hidden;
            position: relative;
        }

        .retro-lyrics-panel::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .retro-lyric-line {
            color: #ffb74d;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            text-shadow: 0 0 8px rgba(255, 183, 77, 0.6);
            white-space: nowrap;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: opacity 0.2s;
        }

        .retro-lyric-line.sub {
            font-size: 12px;
            opacity: 0.6;
            margin-top: 8px;
            color: #ffe0b2;
        }

        /* 复古歌词选择器覆盖层 */
        .retro-lyrics-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 60;
            flex-direction: column;
            padding: 20px;
            font-family: 'VT323', monospace;
        }

        .retro-lyrics-overlay.active {
            display: flex;
        }

        .retro-list-container {
            flex: 1;
            overflow-y: auto;
            border: 2px solid var(--retro-green);
            padding: 10px;
            margin: 15px 0;
            box-shadow: 0 0 10px var(--retro-green);
        }

        .retro-list-item {
            color: var(--retro-green);
            font-size: 18px;
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px dashed rgba(51, 255, 0, 0.3);
        }

        .retro-list-item:hover {
            background: rgba(51, 255, 0, 0.1);
        }

        .retro-list-item.checked::before {
            content: '[X] ';
            color: #fff;
        }

        .retro-list-item::before {
            content: '[ ] ';
            opacity: 0.5;
        }

        /* 修复后的复古按钮样式 - 白字 */
        .retro-action-btn {
            background: #000;
            color: #fff;
            /* 白色文字 */
            border: 2px solid #fff;
            padding: 10px 30px;
            font-family: 'VT323', monospace;
            font-size: 24px;
            cursor: pointer;
            margin: 0 15px;
            text-transform: uppercase;
            transition: all 0.2s;
            box-shadow: 0 0 5px #fff;
            line-height: 1;
        }

        .retro-action-btn:hover {
            background: #fff;
            color: #000;
            box-shadow: 0 0 15px #fff;
        }

        /* 取消按钮 - 保持一致风格 */
        .retro-action-btn.cancel {
            border-color: var(--retro-green);
            color: var(--retro-green);
            box-shadow: none;
        }

        .retro-action-btn.cancel:hover {
            background: var(--retro-green);
            color: #000;
            box-shadow: 0 0 10px var(--retro-green);
        }

        /* 制作卡片按钮新样式 */
        .make-card-btn {
            background: #d35400;
            border: none;
            box-shadow: 0 4px 0 #a04000;
            color: #fff;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .make-card-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #a04000;
        }

        /* 移动端导航 */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0;
            justify-content: space-around;
            align-items: center;
            z-index: 200;
        }

        .mobile-nav-item {
            color: #999;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex: 1;
            height: 100%;
            justify-content: center;
        }

        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-nav-item i {
            font-size: 20px;
        }

        /* 提示框 */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            padding: 10px 25px;
            border-radius: 50px;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }

        .toast.show {
            opacity: 1;
            top: 40px;
        }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .modal-card {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 30px;
            width: 400px;
            max-width: 90%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-preview {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: 0.3s;
        }

        .modal-btn.secondary {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* 隐藏的渲染模板 (统一模板) */
        .lyric-card-template {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 375px;
            min-height: 600px;
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: -apple-system, sans-serif;
            z-index: -9999;
            pointer-events: none;
            /* 确保不会被点击 */
        }

        .card-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(30px) brightness(0.6);
            transform: scale(1.2);
            z-index: 0;
        }

        .card-overlay {
            position: relative;
            z-index: 1;
            padding: 40px 30px;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
        }

        /* 复古拍立得样式 */
        .lyric-card-template.retro-style {
            background: #fdf6e3;
            color: #222;
            border: 15px solid #fff;
            border-bottom: 80px solid #fff;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .lyric-card-template.retro-style .card-bg {
            filter: sepia(0.8) contrast(1.2) brightness(0.9) blur(4px);
            opacity: 0.7;
        }

        .lyric-card-template.retro-style::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            z-index: 5;
            pointer-events: none;
            mix-blend-mode: multiply;
        }

        .lyric-card-template.retro-style .card-lyric-text {
            color: #333;
            font-family: 'VT323', monospace;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.1);
            letter-spacing: 1px;
        }

        .lyric-card-template.retro-style .card-date {
            position: absolute;
            bottom: -60px;
            right: 20px;
            font-family: 'Caveat', cursive;
            color: #444;
            font-size: 24px;
            z-index: 10;
            transform: rotate(-3deg);
        }

        /* 现代样式 */
        .card-lyrics-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .card-lyric-text {
            font-size: 22px;
            line-height: 1.6;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .card-footer {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: auto;
        }

        .card-cover {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            object-fit: cover;
        }

        .card-info {
            flex: 1;
        }

        .card-song-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .card-artist {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .lyric-card-template.retro-style .card-artist {
            color: #555;
        }

        .card-branding {
            position: absolute;
            bottom: 20px;
            right: 30px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lyric-card-template.retro-style .card-branding {
            color: #888;
        }

        /* 响应式适配 */
        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                height: calc(100vh - 60px);
                border-radius: 0;
                border: none;
                padding: 0;
                box-shadow: none;
                width: 100%;
                display: flex;
                flex-direction: column;
            }

            .sidebar {
                display: none;
            }

            .main-view {
                flex: 1;
                width: 100%;
                padding: 15px;
                overflow-y: auto;
                display: none;
                /* 默认隐藏 */
                padding-bottom: 80px;
            }

            .player-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: calc(100% - 60px);
                padding: 20px;
                z-index: 100;
                background: #111;
                display: none;
                flex-direction: column;
            }

            .mobile-nav {
                display: flex;
            }

            body.view-home .main-view {
                display: block;
            }

            body.view-home #radarView {
                display: flex;
            }

            body.view-home #searchView {
                display: none;
            }

            body.view-home #favoritesView {
                display: none;
            }

            body.view-home #localView {
                display: none;
            }

            body.view-search .main-view {
                display: block;
            }

            body.view-search #radarView {
                display: none;
            }

            body.view-search #searchView {
                display: block;
            }

            body.view-search #favoritesView {
                display: none;
            }

            body.view-search #localView {
                display: none;
            }

            body.view-favorites .main-view {
                display: block;
            }

            body.view-favorites #radarView {
                display: none;
            }

            body.view-favorites #searchView {
                display: none;
            }

            body.view-favorites #favoritesView {
                display: block;
            }

            body.view-favorites #localView {
                display: none;
            }

            body.view-local .main-view {
                display: block;
            }

            body.view-local #radarView {
                display: none;
            }

            body.view-local #searchView {
                display: none;
            }

            body.view-local #favoritesView {
                display: none;
            }

            body.view-local #localView {
                display: block;
            }

            body.view-player .player-panel {
                display: flex;
            }

            .album-art {
                width: 240px;
                height: 240px;
                margin-top: 20px;
            }

            .radio-container {
                width: 100%;
                padding: 15px;
                height: 100%;
                justify-content: center;
            }

            .speaker-grill {
                display: none;
            }

            .radio-display-area {
                margin: 0;
                width: 100%;
            }

            .retro-lyrics-panel {
                margin: 15px 0;
                width: 100%;
            }

            .radio-controls {
                flex-wrap: wrap;
            }

            .retro-exit-btn {
                top: 10px;
                right: 10px;
                position: fixed;
                z-index: 60;
            }
        }
    </style>
</head>

<body class="view-home">

    <div class="app-bg" id="appBg"></div>
    <div id="toast" class="toast">欢迎使用 CyberSonic</div>

    <!-- 时光收音机界面 (Retro Layer) -->
    <div id="retroLayer" class="retro-layer">
        <div class="radio-container">
            <!-- 退出按钮 -->
            <div class="retro-exit-btn" onclick="toggleRetroMode()">
                <i class="fas fa-power-off"></i> 关闭电源
            </div>

            <div class="speaker-grill"></div>
            <div class="speaker-grill right"></div>

            <div class="radio-display-area">
                <div class="radio-screen">
                    <div class="cassette-container">
                        <div class="cassette" id="retroCassette">
                            <div class="tape-label" id="tapeLabel">Retro FM 1990</div>
                            <div class="tape-window">
                                <div class="tape-wheel"></div>
                                <div class="tape-wheel"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lcd-display">
                    <div class="lcd-text-main" id="lcdMainText">等待指令...</div>
                    <div class="lcd-text-sub" id="lcdSubText">请选择调频</div>
                </div>
            </div>

            <div class="radio-controls">
                <button class="channel-btn" onclick="playRetroChannel('1980', this)">80年代</button>
                <button class="channel-btn" onclick="playRetroChannel('1990', this)">90年代</button>
                <button class="channel-btn" onclick="playRetroChannel('2000', this)">00年代</button>
                <button class="channel-btn" onclick="playRetroChannel('2010', this)">10年代</button>

                <div class="control-knob" onclick="togglePlay()" title="播放/暂停">
                    <i class="fas fa-play-circle" style="color:#888;"></i>
                </div>

                <button class="channel-btn" onclick="nextSong()" style="background:#5d4037;">切歌</button>
            </div>

            <!-- 复古歌词显示屏 -->
            <div class="retro-lyrics-panel">
                <div class="retro-lyric-line" id="retroLyricMain">CyberSonic Retro System</div>
                <div class="retro-lyric-line sub" id="retroLyricSub">Ready to Play</div>
            </div>

            <div style="text-align: center; margin-top: 10px;">
                <button class="make-card-btn" id="retroCardBtn" onclick="toggleCardMode()">
                    <i class="fas fa-camera-retro"></i> 打印歌词卡片
                </button>
            </div>

            <!-- 复古模式歌词选择覆盖层 -->
            <div id="retroLyricsSelect" class="retro-lyrics-overlay">
                <h3
                    style="color:var(--retro-green); font-family:'VT323',monospace; margin-bottom:10px; text-align:center;">
                    > 请选择歌词行</h3>
                <div id="retroLyricsList" class="retro-list-container"></div>
                <div style="display:flex; justify-content:center;">
                    <button class="retro-action-btn" onclick="generateCard()">[ 确认打印 ]</button>
                    <button class="retro-action-btn cancel" onclick="toggleCardMode()">[ 取消 ]</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- 左侧：导航 -->
        <div class="sidebar">
            <div class="brand">
                <i class="fas fa-bolt"></i>
                <span>CYBERSONIC</span>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="switchTab('home')">
                    <i class="fas fa-compass"></i> 探索雷达
                </div>
                <div class="nav-item" onclick="switchTab('search')">
                    <i class="fas fa-search"></i> 搜索音乐
                </div>
                <div class="nav-item" onclick="switchTab('favorites')">
                    <i class="fas fa-heart"></i> 我的收藏
                </div>
                <div class="nav-item" onclick="switchTab('local')">
                    <i class="fas fa-hdd"></i> 本地音乐
                </div>
                <div class="nav-item" onclick="toggleRetroMode()">
                    <i class="fas fa-radio"></i> 时光电台
                </div>
            </div>
        </div>

        <!-- 中间：内容 -->
        <div class="main-view" id="mainView">
            <!-- 雷达页 -->
            <div id="radarView">
                <div class="radar-circle" id="radarCircle" onclick="startRadar()">
                    <div class="radar-scan"></div>
                    <div class="radar-text" id="radarText">点击扫描</div>
                </div>
                <p style="color: var(--text-sub); margin-top: 20px;">AI 智能探索全网随机歌单</p>
            </div>

            <!-- 搜索页 -->
            <div id="searchView" style="display: none;">
                <div class="search-bar">
                    <select id="sourceSelect" class="source-select">
                        <option value="netease" selected>网易云</option>
                        <option value="qq">QQ音乐</option>
                        <option value="kuwo">酷我</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="搜一搜..."
                        onkeypress="if(event.keyCode===13) doSearch()">
                    <i class="fas fa-search search-btn" onclick="doSearch()"></i>
                </div>
                <div class="song-list" id="songList"></div>
            </div>

            <!-- 收藏页 -->
            <div id="favoritesView" style="display: none;">
                <div class="section-title"
                    style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #fff; display:flex; align-items:center;">
                    <i class="fas fa-heart" style="color: var(--secondary); margin-right: 10px;"></i> 我的收藏

                    <div style="margin-left: auto; display: flex; gap: 10px;">
                        <button class="action-pill" style="font-size: 12px; padding: 4px 10px;" onclick="exportData()"
                            title="导出备份"><i class="fas fa-download"></i> 备份</button>
                        <button class="action-pill" style="font-size: 12px; padding: 4px 10px;"
                            onclick="document.getElementById('importFile').click()" title="恢复数据"><i
                                class="fas fa-upload"></i> 恢复</button>
                        <span style="font-size: 14px; opacity: 0.5; font-weight: normal; align-self: center;"
                            id="favCount">0 首</span>
                    </div>
                </div>
                <div class="song-list" id="favList">
                    <div style="text-align: center; color: #666; margin-top: 50px;">
                        <i class="far fa-heart" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <p>暂无收藏歌曲</p>
                    </div>
                </div>
            </div>

            <!-- 本地音乐页 -->
            <div id="localView" style="display: none;">
                <div class="section-title"
                    style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #fff; display:flex; align-items:center;">
                    <i class="fas fa-hdd" style="color: var(--primary); margin-right: 10px;"></i> 本地音乐
                </div>
                <input type="file" id="fileInput" accept="audio/*" multiple style="display:none"
                    onchange="handleLocalFiles(this.files)">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()"
                    style="border: 2px dashed rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 40px; text-align: center; color: rgba(255, 255, 255, 0.6); cursor: pointer; transition: 0.3s; margin-bottom: 20px; background: rgba(255,255,255,0.02);">
                    <i class="fas fa-cloud-upload-alt"
                        style="font-size: 40px; margin-bottom: 15px; color: var(--primary);"></i>
                    <p>点击或拖拽上传音乐文件</p>
                    <span style="font-size:12px; opacity:0.5">支持 MP3, FLAC, WAV</span>
                </div>
                <div class="song-list" id="localList"></div>
            </div>
        </div>

        <!-- 右侧：播放器 -->
        <div class="player-panel" id="playerPanel">
            <button class="card-entry-btn" id="cardModeBtn" onclick="toggleCardMode()">
                <i class="fas fa-magic"></i> 制作歌词卡片
            </button>

            <div class="album-art" id="albumArtContainer">
                <img src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=500&auto=format&fit=crop"
                    id="coverImg">
            </div>

            <!-- 新增：歌曲信息区域 -->
            <div class="song-info-area">
                <div class="current-title" id="currentTitle">CyberSonic Player</div>
                <div class="current-artist" id="currentArtist">Waiting for music...</div>
            </div>

            <div class="lyrics-wrapper" id="lyricsWrapper">
                <div class="lyrics-inner" id="lyricsInner">
                    <div class="lyric-line">点击探索雷达</div>
                    <div class="lyric-line">开始随机播放</div>
                </div>
            </div>

            <div class="card-actions-bar" id="cardActions">
                <button class="action-pill" onclick="generateCard()">✨ 生成海报</button>
                <button class="action-pill cancel" onclick="toggleCardMode()">退出</button>
            </div>

            <!-- 底部控制区 -->
            <div class="controls">
                <canvas id="visualizerCanvas" width="320" height="120"></canvas>

                <div class="progress-bar" onclick="seek(event)">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="btn-group">
                    <!-- 收藏按钮 -->
                    <button class="ctrl-btn" id="favBtn" onclick="toggleFavorite()" title="收藏">
                        <i class="far fa-heart"></i>
                    </button>

                    <button class="ctrl-btn" onclick="downloadCurrentSong()" title="下载"><i
                            class="fas fa-download"></i></button>

                    <button class="ctrl-btn" onclick="prevSong()" title="上一首"><i
                            class="fas fa-step-backward"></i></button>
                    <button class="play-btn" id="playBtn" onclick="togglePlay()" title="播放/暂停"><i
                            class="fas fa-play"></i></button>
                    <button class="ctrl-btn" onclick="nextSong()" title="下一首"><i
                            class="fas fa-step-forward"></i></button>
                </div>

                <!-- 音量控制条 -->
                <div class="volume-control">
                    <i class="fas fa-volume-down" style="font-size: 12px; opacity: 0.7;"></i>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100"
                        oninput="setVolume(this.value)">
                    <i class="fas fa-volume-up" style="font-size: 12px; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 移动端底部导航 -->
    <div class="mobile-nav">
        <div class="mobile-nav-item active" onclick="switchTab('home')">
            <i class="fas fa-compass"></i> 探索
        </div>
        <div class="mobile-nav-item" onclick="switchTab('search')">
            <i class="fas fa-search"></i> 搜索
        </div>
        <div class="mobile-nav-item" onclick="switchTab('favorites')">
            <i class="fas fa-heart"></i> 收藏
        </div>
        <div class="mobile-nav-item" onclick="toggleRetroMode()">
            <i class="fas fa-radio"></i> 时光
        </div>
        <div class="mobile-nav-item" onclick="switchTab('player')">
            <i class="fas fa-music"></i> 播放
        </div>
    </div>

    <audio id="audio"></audio>

    <!-- 数据恢复文件输入框 -->
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this.files)">

    <div class="modal" id="cardModal">
        <div class="modal-card">
            <h3 style="color: #fff; margin-bottom: 15px;">歌词卡片已生成</h3>
            <img id="resultImg" class="card-preview">
            <button class="modal-btn" onclick="downloadCard()">下载保存</button>
            <button class="modal-btn secondary" onclick="closeModal()">关闭</button>
        </div>
    </div>

    <!-- 统一的渲染模板 -->
    <div id="cardTemplate" class="lyric-card-template">
        <div class="card-bg" id="tplBg"></div>
        <div class="card-overlay">
            <div class="card-lyrics-area" id="tplLyrics"></div>

            <div class="card-footer">
                <!-- 加上透明占位符防止破碎 -->
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                    class="card-cover" id="tplCover" crossorigin="anonymous">
                <div class="card-info">
                    <div class="card-song-name" id="tplTitle">歌曲名</div>
                    <div class="card-artist" id="tplArtist">歌手名</div>
                </div>
                <div class="card-branding">
                    <i class="fas fa-music"></i> 云音乐
                </div>
            </div>
            <!-- 复古模式特有的日期水印 -->
            <div class="card-date" id="cardDate"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://music-api.gdstudio.xyz/api.php';

        // State
        let currentPlaylist = [];
        let localPlaylist = [];
        let currentIndex = -1;
        let lyricsData = [];
        let isPlaying = false;
        let isCardMode = false;
        let isManualScrolling = false;
        let scrollTimeout;
        let selectedLyrics = new Set();
        let favoriteSongs = [];
        let isRetroMode = false;
        let audioCtx;

        const audio = document.getElementById('audio');
        const lyricsWrapper = document.getElementById('lyricsWrapper');

        // PWA Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                if (location.protocol === 'http:' || location.protocol === 'https:') {
                    navigator.serviceWorker.register('./sw.js').catch(console.error);
                }
            });
        }

        // --- 初始化收藏 ---
        function initFavorites() {
            const saved = localStorage.getItem('cybersonic_favs');
            if (saved) favoriteSongs = JSON.parse(saved);
            renderFavorites();
        }

        // --- 模拟频谱可视化 ---
        const canvas = document.getElementById('visualizerCanvas');
        const ctx = canvas.getContext('2d');
        let visualizerAnimation;

        function drawVisualizer() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!isPlaying) return;
            const bars = 30;
            const barWidth = canvas.width / bars;
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
            for (let i = 0; i < bars; i++) {
                const height = Math.random() * canvas.height * 0.6;
                const x = i * barWidth;
                const y = canvas.height - height;
                ctx.beginPath();
                ctx.roundRect(x + 2, y, barWidth - 4, height, 5);
                ctx.fill();
            }
            visualizerAnimation = requestAnimationFrame(drawVisualizer);
        }

        function startVisualizer() { cancelAnimationFrame(visualizerAnimation); drawVisualizer(); }
        function stopVisualizer() { cancelAnimationFrame(visualizerAnimation); ctx.clearRect(0, 0, canvas.width, canvas.height); }

        // --- 核心逻辑 ---
        lyricsWrapper.addEventListener('touchstart', () => { isManualScrolling = true; }, { passive: true });
        lyricsWrapper.addEventListener('scroll', () => {
            isManualScrolling = true;
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => { isManualScrolling = false; }, 3000);
        });

        audio.addEventListener('error', (e) => {
            console.error("Audio error:", e);
            if (currentPlaylist[currentIndex]) {
                showToast("当前源失效，正在尝试切换...");
                tryAutoSwitchSource(currentPlaylist[currentIndex]);
            } else {
                showToast("播放失败");
                isPlaying = false;
                updatePlayBtn();
                document.getElementById('albumArtContainer').classList.remove('playing');
                stopVisualizer();
            }
        });

        // 辅助函数：Fisher-Yates 洗牌算法
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function doSearch(keywordOverride, count = 20, shuffle = false) {
            const keyword = keywordOverride || document.getElementById('searchInput').value;
            const sourceSelect = document.getElementById('sourceSelect');
            const source = sourceSelect ? sourceSelect.value : 'netease';

            if (!keyword) return showToast("请输入关键词");

            switchTab('search');
            if (keywordOverride) document.getElementById('searchInput').value = keywordOverride;

            const listEl = document.getElementById('songList');
            listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#666;"><i class="fas fa-spinner fa-spin"></i> 搜索中...</div>';

            try {
                const res = await fetch(`${API_BASE}?types=search&count=${count}&source=${source}&pages=1&name=${encodeURIComponent(keyword)}`);
                const data = await res.json();

                currentPlaylist = data;
                if (shuffle) shuffleArray(currentPlaylist);

                renderList(currentPlaylist, 'songList');

                if (data.length === 0) {
                    listEl.innerHTML = '<div style="text-align:center; color:#aaa;">未找到相关歌曲</div>';
                }
            } catch (e) {
                listEl.innerHTML = '<div style="text-align:center; color:#ff4d4f;">搜索失败</div>';
            }
        }

        function renderList(songs, containerId) {
            const listEl = document.getElementById(containerId);
            listEl.innerHTML = '';
            songs.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = 'song-item';
                div.innerHTML = `
                    <div class="song-index">${index + 1}</div>
                    <div class="song-title">${song.name}</div>
                    <div class="song-artist">${Array.isArray(song.artist) ? song.artist.join('/') : song.artist}</div>
                    <div class="song-source">${song.source}</div>
                `;
                div.onclick = () => playMusic(index, songs);
                listEl.appendChild(div);
            });
        }

        // 本地音乐处理
        function handleLocalFiles(files) {
            if (!files.length) return;
            Array.from(files).forEach(file => {
                localPlaylist.push({
                    name: file.name.replace(/\.[^/.]+$/, ""), // Remove extension
                    artist: 'Local File',
                    source: 'local',
                    url: URL.createObjectURL(file),
                    file: file
                });
            });
            renderLocalList();
            showToast(`已添加 ${files.length} 首本地音乐`);
        }

        function renderLocalList() {
            const listEl = document.getElementById('localList');
            listEl.innerHTML = '';
            localPlaylist.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = 'song-item';
                div.innerHTML = `
                    <div class="song-index">${index + 1}</div>
                    <div class="song-title">${song.name}</div>
                    <div class="song-artist">${song.artist}</div>
                    <div class="song-source"><i class="fas fa-hdd"></i></div>
                `;
                div.onclick = () => playMusic(index, localPlaylist);
                listEl.appendChild(div);
            });
        }

        // 渲染收藏列表
        function renderFavorites() {
            const listEl = document.getElementById('favList');
            const countEl = document.getElementById('favCount');
            countEl.innerText = `${favoriteSongs.length} 首`;

            if (favoriteSongs.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; color: #666; margin-top: 50px;">
                        <i class="far fa-heart" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <p>暂无收藏歌曲</p>
                    </div>`;
                return;
            }

            listEl.innerHTML = '';
            favoriteSongs.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = 'song-item';
                div.innerHTML = `
                    <div class="song-index">${index + 1}</div>
                    <div class="song-title">${song.name}</div>
                    <div class="song-artist">${Array.isArray(song.artist) ? song.artist.join('/') : song.artist}</div>
                    <div class="song-source">${song.source}</div>
                `;
                div.onclick = () => playMusic(index, favoriteSongs);
                listEl.appendChild(div);
            });
        }

        // 收藏功能
        function toggleFavorite() {
            if (currentIndex === -1) return showToast("请先播放歌曲");

            const song = currentPlaylist[currentIndex];
            // Local files cannot be favorited persistently in this simple version
            if (song.source === 'local') return showToast("本地音乐暂不支持收藏");

            const idx = favoriteSongs.findIndex(s => s.id === song.id && s.source === song.source);

            if (idx > -1) {
                favoriteSongs.splice(idx, 1);
                showToast("已取消收藏");
            } else {
                favoriteSongs.unshift(song);
                showToast("已加入收藏 ❤️");
            }

            localStorage.setItem('cybersonic_favs', JSON.stringify(favoriteSongs));
            updateFavBtn();
            renderFavorites();
        }

        function updateFavBtn() {
            const btn = document.getElementById('favBtn');
            if (currentIndex === -1) {
                btn.innerHTML = '<i class="far fa-heart"></i>';
                btn.classList.remove('active');
                return;
            }

            const song = currentPlaylist[currentIndex];
            const isFav = favoriteSongs.some(s => s.id === song.id && s.source === song.source);

            if (isFav) {
                btn.innerHTML = '<i class="fas fa-heart"></i>';
                btn.classList.add('active');
            } else {
                btn.innerHTML = '<i class="far fa-heart"></i>';
                btn.classList.remove('active');
            }
        }

        // 备份与恢复
        function exportData() {
            if (favoriteSongs.length === 0) return showToast("收藏夹为空，无需备份");
            const dataStr = JSON.stringify(favoriteSongs);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = `CyberSonic_Backup_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showToast("备份文件已下载");
        }

        function importData(files) {
            if (files.length === 0) return;
            const file = files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        favoriteSongs = data;
                        localStorage.setItem('cybersonic_favs', JSON.stringify(favoriteSongs));
                        renderFavorites();
                        showToast(`成功恢复 ${data.length} 首歌曲`);
                    } else {
                        showToast("文件格式错误");
                    }
                } catch (err) {
                    showToast("无法解析文件");
                }
            };
            reader.readAsText(file);
            // Reset input
            document.getElementById('importFile').value = '';
        }

        // 播放逻辑
        async function playMusic(index, playlistContext = null) {
            if (playlistContext) {
                currentPlaylist = playlistContext;
            }

            currentIndex = index;
            const song = currentPlaylist[index];
            const sourceToUse = song.source;

            document.querySelectorAll('.song-item').forEach(el => el.classList.remove('active'));

            if (window.innerWidth <= 900) switchTab('player');

            audio.pause();
            isPlaying = false;
            updatePlayBtn();
            stopVisualizer();
            document.getElementById('albumArtContainer').classList.remove('playing');

            updateFavBtn();

            if (isRetroMode) {
                document.getElementById('lcdMainText').textContent = song.name;
                document.getElementById('lcdSubText').textContent = Array.isArray(song.artist) ? song.artist.join('/') : song.artist;
            }

            // Update text in Player
            document.getElementById('currentTitle').textContent = song.name;
            document.getElementById('currentArtist').textContent = Array.isArray(song.artist) ? song.artist.join('/') : song.artist;

            // 本地音乐直接播放
            if (sourceToUse === 'local') {
                audio.src = song.url;
                audio.play();
                isPlaying = true;
                updatePlayBtn();
                startVisualizer();
                document.getElementById('albumArtContainer').classList.add('playing');
                // Local cover placeholder
                const cover = 'https://images.unsplash.com/photo-1493225255756-d9584f8606e9?q=80&w=500';
                document.getElementById('coverImg').src = cover;
                document.getElementById('appBg').style.backgroundImage = `url(${cover})`;
                document.getElementById('lyricsInner').innerHTML = '<div class="lyric-line">本地音乐暂无歌词</div>';
                if (isRetroMode) {
                    document.getElementById('retroLyricMain').innerText = song.name;
                    document.getElementById('retroLyricSub').innerText = "Local File";
                }
                return;
            }

            try {
                showToast(`正在加载: ${song.name}`);

                const [urlData, picData, lrcData] = await Promise.all([
                    fetch(`${API_BASE}?types=url&id=${song.id}&source=${sourceToUse}`).then(r => r.json()),
                    fetch(`${API_BASE}?types=pic&id=${song.pic_id}&source=${sourceToUse}`).then(r => r.json()),
                    fetch(`${API_BASE}?types=lyric&id=${song.lyric_id}&source=${sourceToUse}`).then(r => r.json())
                ]);

                if (urlData.url) {
                    let finalUrl = urlData.url;
                    if (location.protocol === 'https:' && finalUrl.startsWith('http:')) {
                        finalUrl = finalUrl.replace('http:', 'https:');
                    }

                    audio.src = finalUrl;

                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayBtn();
                            startVisualizer();
                            document.getElementById('albumArtContainer').classList.add('playing');
                            if (isRetroMode) document.getElementById('retroCassette').classList.add('playing');
                        }).catch(err => {
                            console.warn("Play blocked or error", err);
                            tryAutoSwitchSource(song, sourceToUse);
                        });
                    }

                    const cover = picData.url || 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=500';
                    document.getElementById('coverImg').src = cover;
                    document.getElementById('appBg').style.backgroundImage = `url(${cover})`;

                    if (lrcData.lyric) parseLyrics(lrcData.lyric, lrcData.tlyric);
                    else {
                        document.getElementById('lyricsInner').innerHTML = '<div class="lyric-line">暂无歌词</div>';
                        document.getElementById('retroLyricMain').innerText = "暂无歌词";
                        document.getElementById('retroLyricSub').innerText = "";
                    }

                } else {
                    tryAutoSwitchSource(song, sourceToUse);
                }
            } catch (e) {
                console.error(e);
                tryAutoSwitchSource(song, sourceToUse);
            }
        }

        async function tryAutoSwitchSource(originalSong, failedSource) {
            const fallbackSources = ['kuwo', 'tencent', 'netease'];
            const nextSources = fallbackSources.filter(s => s !== failedSource && s !== originalSong.source);

            showToast(`当前源不可用，正在搜索替补源...`);

            for (const src of nextSources) {
                try {
                    const searchRes = await fetch(`${API_BASE}?types=search&count=5&source=${src}&pages=1&name=${encodeURIComponent(originalSong.name + ' ' + (Array.isArray(originalSong.artist) ? originalSong.artist[0] : originalSong.artist))}`);
                    const searchData = await searchRes.json();

                    if (searchData && searchData.length > 0) {
                        const match = searchData[0];
                        const urlRes = await fetch(`${API_BASE}?types=url&id=${match.id}&source=${src}`);
                        const urlData = await urlRes.json();

                        if (urlData.url) {
                            showToast(`已自动切换至: ${src}`);
                            let finalUrl = urlData.url;
                            if (location.protocol === 'https:' && finalUrl.startsWith('http:')) {
                                finalUrl = finalUrl.replace('http:', 'https:');
                            }
                            audio.src = finalUrl;
                            audio.play();
                            isPlaying = true;
                            updatePlayBtn();
                            startVisualizer();
                            document.getElementById('albumArtContainer').classList.add('playing');
                            if (isRetroMode) document.getElementById('retroCassette').classList.add('playing');
                            return;
                        }
                    }
                } catch (e) { console.log(`Fallback to ${src} failed`); }
            }
            showToast("全网资源搜索失败，请尝试下一首");
        }

        function parseLyrics(lrc, tlyric) {
            lyricsData = [];
            const lines = lrc.split('\n');
            const transLines = tlyric ? tlyric.split('\n') : [];
            const regex = /\[(\d{2}):(\d{2})(?:\.(\d{1,3}))?\](.*)/;

            const transMap = {};
            transLines.forEach(line => {
                const match = line.match(regex);
                if (match && match[4].trim()) {
                    const key = `${parseInt(match[1])}:${parseInt(match[2])}`;
                    transMap[key] = match[4].trim();
                }
            });

            lines.forEach(line => {
                const match = line.match(regex);
                if (match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    const ms = match[3] ? parseInt(match[3].padEnd(3, '0')) : 0;
                    const time = min * 60 + sec + ms / 1000;
                    const text = match[4].trim();
                    const trans = transMap[`${min}:${sec}`] || '';
                    if (text) lyricsData.push({ time, text, trans });
                }
            });
            renderLyricsUI();
        }

        function renderLyricsUI() {
            const inner = document.getElementById('lyricsInner');
            inner.innerHTML = '';
            lyricsData.forEach((line, idx) => {
                const div = document.createElement('div');
                div.className = 'lyric-line';
                div.innerHTML = `<div>${line.text}</div>${line.trans ? `<div class="trans">${line.trans}</div>` : ''}`;
                div.id = `line-${idx}`;
                div.onclick = () => {
                    if (isCardMode) toggleLyricSelection(idx, div);
                    else audio.currentTime = line.time;
                };
                inner.appendChild(div);
            });
        }

        // --- 复古模式歌词渲染器 ---
        function renderRetroLyricsUI() {
            const list = document.getElementById('retroLyricsList');
            list.innerHTML = '';
            lyricsData.forEach((line, idx) => {
                const div = document.createElement('div');
                div.className = 'retro-list-item';
                div.innerText = line.text;
                div.onclick = () => {
                    toggleLyricSelection(idx, div);
                    div.classList.toggle('checked', selectedLyrics.has(idx));
                };
                list.appendChild(div);
            });
        }

        audio.addEventListener('timeupdate', () => {
            const percent = (audio.currentTime / audio.duration) * 100 || 0;
            document.getElementById('progressFill').style.width = percent + '%';
            if (!isCardMode) syncLyrics();
        });

        function syncLyrics() {
            const time = audio.currentTime;
            let activeIdx = -1;
            for (let i = 0; i < lyricsData.length; i++) {
                if (lyricsData[i].time <= time) activeIdx = i;
                else break;
            }

            if (activeIdx !== -1) {
                // 1. Update modern UI
                document.querySelectorAll('.lyric-line').forEach(l => l.classList.remove('active'));
                const el = document.getElementById(`line-${activeIdx}`);
                if (el) {
                    el.classList.add('active');
                    if (!isManualScrolling) {
                        el.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                }

                // 2. Update Retro UI
                if (isRetroMode) {
                    const currentLine = lyricsData[activeIdx];
                    const nextLine = lyricsData[activeIdx + 1];
                    if (currentLine) {
                        document.getElementById('retroLyricMain').innerText = currentLine.text;
                        document.getElementById('retroLyricSub').innerText = currentLine.trans || (nextLine ? nextLine.text : '');
                    }
                }
            }
        }

        function togglePlay() {
            if (audio.paused) {
                audio.play().then(() => {
                    isPlaying = true;
                    updatePlayBtn();
                    startVisualizer();
                    document.getElementById('albumArtContainer').classList.add('playing');
                    if (isRetroMode) document.getElementById('retroCassette').classList.add('playing');
                }).catch(() => showToast("播放失败"));
            } else {
                audio.pause();
                isPlaying = false;
                updatePlayBtn();
                stopVisualizer();
                document.getElementById('albumArtContainer').classList.remove('playing');
                if (isRetroMode) document.getElementById('retroCassette').classList.remove('playing');
            }
        }

        function updatePlayBtn() {
            const btn = document.getElementById('playBtn');
            btn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
        }

        function prevSong() {
            if (currentIndex > 0) playMusic(currentIndex - 1);
            else showToast("已经是第一首了");
        }

        function nextSong() {
            if (currentIndex < currentPlaylist.length - 1) playMusic(currentIndex + 1);
            else showToast("已经是最后一首了");
        }

        audio.addEventListener('ended', nextSong);

        function seek(e) {
            const bar = e.currentTarget;
            const percent = e.offsetX / bar.offsetWidth;
            audio.currentTime = percent * audio.duration;
        }

        async function downloadCurrentSong() {
            if (currentIndex === -1 || !currentPlaylist[currentIndex]) {
                return showToast("请先播放一首歌曲");
            }

            const song = currentPlaylist[currentIndex];
            showToast(`正在解析下载链接: ${song.name}`);

            try {
                const res = await fetch(`${API_BASE}?types=url&id=${song.id}&source=${song.source}&br=320`);
                const data = await res.json();

                if (!data.url) return showToast("无法获取下载地址");

                let downUrl = data.url;
                if (location.protocol === 'https:' && downUrl.startsWith('http:')) {
                    if (downUrl.includes('126.net') || downUrl.includes('qq.com')) {
                        downUrl = downUrl.replace('http:', 'https:');
                    }
                }

                fetch(downUrl)
                    .then(resp => resp.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        const artist = Array.isArray(song.artist) ? song.artist.join(',') : song.artist;
                        a.download = `${artist} - ${song.name}.mp3`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        showToast("下载已开始");
                    })
                    .catch(() => {
                        const link = document.createElement('a');
                        link.href = downUrl;
                        link.target = '_blank';
                        link.download = `${song.name}.mp3`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showToast("已调起浏览器下载");
                    });

            } catch (e) {
                showToast("下载服务出错");
            }
        }

        function startRadar() {
            const circle = document.getElementById('radarCircle');
            const text = document.getElementById('radarText');

            if (circle.classList.contains('scanning')) return;
            circle.classList.add('scanning');
            text.innerText = "正在扫描...";

            setTimeout(() => {
                circle.classList.remove('scanning');
                text.innerText = "扫描完成";
                const keywords = ["抖音热歌", "欧美金曲", "古风", "周杰伦", "陈奕迅", "林俊杰", "ACG"];
                const randomKey = keywords[Math.floor(Math.random() * keywords.length)];
                if (document.getElementById('sourceSelect')) {
                    document.getElementById('sourceSelect').value = 'netease';
                }
                doSearch(randomKey, 50, true);
                showToast(`已锁定信号: ${randomKey}`);
            }, 2000);
        }

        // 时光电台逻辑
        function toggleRetroMode() {
            isRetroMode = !isRetroMode;
            document.body.classList.toggle('retro-mode', isRetroMode);

            // 同步更新卡片按钮文字
            const cardBtn = document.getElementById('cardModeBtn');
            const retroCardBtn = document.getElementById('retroCardBtn');

            if (isRetroMode) {
                showToast('欢迎进入时光电台 Mode', 'success');
                playStaticNoise(0.5);
                if (!isPlaying) setTimeout(() => playRetroChannel('1990'), 1000);

                if (cardBtn) cardBtn.style.display = 'none';
                if (retroCardBtn) retroCardBtn.style.display = 'inline-flex';
            } else {
                if (cardBtn) cardBtn.style.display = 'flex';
                if (retroCardBtn) retroCardBtn.style.display = 'none';
            }
        }

        async function playRetroChannel(decade, btnElement) {
            playStaticNoise(0.8);
            document.querySelectorAll('.channel-btn').forEach(btn => btn.classList.remove('active'));
            if (btnElement) btnElement.classList.add('active');

            document.getElementById('lcdMainText').textContent = `FM ${decade}s`;
            document.getElementById('lcdSubText').textContent = "正在调频...";
            document.getElementById('tapeLabel').textContent = `Mixtape ${decade}`;

            const keywords = [`${decade}年金曲`, `${decade}s hits`, `经典老歌${decade}`];
            const keyword = keywords[Math.floor(Math.random() * keywords.length)];

            try {
                const response = await fetch(`${API_BASE}?types=search&source=netease&name=${encodeURIComponent(keyword)}&count=20`);
                const data = await response.json();
                if (data && data.length > 0) {
                    shuffleArray(data);
                    currentPlaylist = data;
                    playMusic(0);
                    setTimeout(() => { document.getElementById('lcdSubText').textContent = "播放中"; }, 1000);
                } else {
                    document.getElementById('lcdMainText').textContent = "NO SIGNAL";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('lcdMainText').textContent = "ERROR";
            }
        }

        // 白噪音
        function playStaticNoise(duration) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.1;
            noise.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            noise.start();
        }

        function toggleCardMode() {
            isCardMode = !isCardMode;
            const btn = document.getElementById('cardModeBtn');
            const retroBtn = document.getElementById('retroCardBtn');
            const panel = document.getElementById('playerPanel');
            const actions = document.getElementById('cardActions');
            const lines = document.querySelectorAll('.lyric-line');
            const retroOverlay = document.getElementById('retroLyricsSelect');

            // 通用重置
            selectedLyrics.clear();

            if (isCardMode) {
                // 激活状态
                if (isRetroMode) {
                    // 复古模式：显示覆盖层
                    retroOverlay.classList.add('active');
                    if (retroBtn) {
                        retroBtn.classList.add('active');
                        retroBtn.innerHTML = '<i class="fas fa-times"></i> 退出制作';
                    }
                    renderRetroLyricsUI(); // 渲染歌词列表
                } else {
                    // 现代模式
                    if (btn) {
                        btn.classList.add('active');
                        btn.innerHTML = '<i class="fas fa-times"></i> 退出制作';
                    }
                    panel.classList.add('card-mode');
                    actions.style.opacity = 1; actions.style.pointerEvents = 'auto';
                }
                showToast("点击歌词行选择，然后点击「生成海报」");
            } else {
                // 取消状态
                if (isRetroMode) {
                    retroOverlay.classList.remove('active');
                    if (retroBtn) {
                        retroBtn.classList.remove('active');
                        retroBtn.innerHTML = '<i class="fas fa-camera-retro"></i> 打印歌词卡片';
                    }
                } else {
                    if (btn) {
                        btn.classList.remove('active');
                        btn.innerHTML = '<i class="fas fa-magic"></i> 制作歌词卡片';
                    }
                    panel.classList.remove('card-mode');
                    actions.style.opacity = 0; actions.style.pointerEvents = 'none';
                    lines.forEach(l => l.classList.remove('selected'));
                }
            }
        }

        function toggleLyricSelection(idx, el) {
            if (selectedLyrics.has(idx)) {
                selectedLyrics.delete(idx);
                if (el) el.classList.remove('selected');
            } else {
                selectedLyrics.add(idx);
                if (el) el.classList.add('selected');
            }
        }

        async function generateCard() {
            if (selectedLyrics.size === 0) return showToast("请至少选择一句歌词");
            showToast("正在冲印海报...");
            const song = currentPlaylist[currentIndex];

            const sortedIndices = Array.from(selectedLyrics).sort((a, b) => a - b);
            const lyricsText = sortedIndices.map(i => {
                const l = lyricsData[i];
                return `<div>${l.text}</div>${l.trans ? `<div style="font-size:0.6em; opacity:0.7; margin-top:4px;">${l.trans}</div>` : ''}`;
            }).join('<br>');

            // 统一使用 cardTemplate ID
            const template = document.getElementById('cardTemplate');
            // 使用修正后的ID
            document.getElementById('tplLyrics').innerHTML = lyricsText;
            document.getElementById('tplTitle').innerText = song.name;
            document.getElementById('tplArtist').innerText = Array.isArray(song.artist) ? song.artist.join('/') : song.artist;

            // Retro Style handling
            if (isRetroMode) {
                template.classList.add('retro-style');
                document.getElementById('cardDate').innerText = new Date().toLocaleDateString();
            } else {
                template.classList.remove('retro-style');
                document.getElementById('cardDate').innerText = '';
            }

            const coverUrl = document.getElementById('coverImg').src;
            const base64Cover = await getBase64(coverUrl);
            document.getElementById('tplCover').src = base64Cover;
            document.getElementById('tplBg').style.backgroundImage = `url(${base64Cover})`;

            // 统一使用 cardTemplate 进行截图
            try {
                // 临时移除 -9999px 以便 html2canvas 能够渲染
                // 但 html2canvas 其实支持渲染不在视口内的元素，只要不 display:none
                const canvas = await html2canvas(template, { useCORS: true, backgroundColor: '#000' });
                document.getElementById('resultImg').src = canvas.toDataURL("image/png");
                document.getElementById('cardModal').style.display = 'flex';
            } catch (e) {
                console.error(e);
                showToast("生成失败");
            }
        }

        function getBase64(url) {
            return fetch(url).then(r => r.blob()).then(b => new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(b);
            })).catch(() => 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');
        }

        function switchTab(tab) {
            if (window.innerWidth <= 900) {
                document.body.className = `view-${tab}`;
            }

            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent.trim().includes(tab === 'home' ? '探索' : (tab === 'search' ? '搜索' : (tab === 'favorites' ? '收藏' : '播放')))) {
                    item.classList.add('active');
                }
            });

            // Desktop Logic
            document.getElementById('radarView').style.display = 'none';
            document.getElementById('searchView').style.display = 'none';
            document.getElementById('favoritesView').style.display = 'none';
            document.getElementById('localView').style.display = 'none';

            if (tab === 'home') {
                document.getElementById('radarView').style.display = 'flex';
            } else if (tab === 'search') {
                document.getElementById('searchView').style.display = 'block';
            } else if (tab === 'favorites') {
                document.getElementById('favoritesView').style.display = 'block';
                renderFavorites(); // Refresh list
            } else if (tab === 'local') {
                document.getElementById('localView').style.display = 'block';
            }

            updateNav(tab);
        }

        function updateNav(active) {
            document.querySelectorAll('.nav-item').forEach((el, idx) => {
                el.classList.remove('active');
                if (active === 'home' && idx === 0) el.classList.add('active');
                if (active === 'search' && idx === 1) el.classList.add('active');
                if (active === 'favorites' && idx === 2) el.classList.add('active');
                if (active === 'local' && idx === 3) el.classList.add('active');
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function closeModal() { document.getElementById('cardModal').style.display = 'none'; }
        function downloadCard() {
            const link = document.createElement('a');
            link.download = `CyberSonic_${Date.now()}.png`;
            link.href = document.getElementById('resultImg').src;
            link.click();
        }

        // --- 新增：键盘快捷键支持 ---
        document.addEventListener('keydown', (e) => {
            // 如果焦点在输入框内，不触发快捷键
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.code) {
                case 'Space': // 空格：播放/暂停
                    e.preventDefault(); // 防止页面滚动
                    togglePlay();
                    break;
                case 'ArrowLeft': // 左箭头
                    if (e.ctrlKey || e.metaKey) {
                        prevSong(); // Ctrl + 左：上一首
                    } else {
                        audio.currentTime = Math.max(0, audio.currentTime - 5); // 左：快退 5秒
                        showToast("⏪ 快退 5s");
                    }
                    break;
                case 'ArrowRight': // 右箭头
                    if (e.ctrlKey || e.metaKey) {
                        nextSong(); // Ctrl + 右：下一首
                    } else {
                        audio.currentTime = Math.min(audio.duration, audio.currentTime + 5); // 右：快进 5秒
                        showToast("⏩ 快进 5s");
                    }
                    break;
                case 'ArrowUp': // 上箭头：音量 +
                    e.preventDefault();
                    const newVolUp = Math.min(1, audio.volume + 0.1);
                    audio.volume = newVolUp;
                    document.querySelector('.volume-slider').value = newVolUp * 100;
                    showToast(`🔊 音量: ${Math.round(newVolUp * 100)}%`);
                    break;
                case 'ArrowDown': // 下箭头：音量 -
                    e.preventDefault();
                    const newVolDown = Math.max(0, audio.volume - 0.1);
                    audio.volume = newVolDown;
                    document.querySelector('.volume-slider').value = newVolDown * 100;
                    showToast(`🔉 音量: ${Math.round(newVolDown * 100)}%`);
                    break;
            }
        });

        // Init
        initFavorites();
        switchTab('home');
    </script>
</body>

</html>
